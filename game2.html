// --- è®Šæ•¸è¨­å®š ---
let piecesRevealed = new Set();
let totalPieces = 20;
let gameMode = '';
let level = 1;

// ç­”æ¡ˆå„²å­˜
let correctMath = 0;
let correctH = 0;
let correctM = 0;

// è¨ˆæ™‚å™¨
let timerInterval;
let timeLeft = 20 * 60;

// ç•«å¸ƒ
let canvas, ctx, img, clockCtx;
const puzzleUrl = 'https://wallpapers.com/images/hd/cinnamoroll-sanrio-character-kj9funibekfso7sj.jpg';
const tileW = 80, tileH = 80, cols = 5, rows = 4;

// --- ç³»çµ±åŠŸèƒ½ ---
function toggleMenu(id) {
    document.querySelectorAll('[id$="-levels"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(id + '-levels').classList.remove('hidden');
}

function startGame(mode, lvl) {
    gameMode = mode;
    level = lvl;
    piecesRevealed.clear();
    timeLeft = 20 * 60;

    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('clock-canvas').style.display = (mode === 'time') ? 'block' : 'none';

    // åˆ‡æ›è¼¸å…¥æ¡†
    document.getElementById('input-math').classList.toggle('hidden', mode === 'time');
    document.getElementById('input-time').classList.toggle('hidden', mode !== 'time');

    initPuzzle();
    if (mode === 'time') initClock();
    startTimer();
    generateQuestion();
}

function startTimer() {
    clearInterval(timerInterval);
    updateTimerUI();
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerUI();
        if (timeLeft <= 0) gameOver(false);
    }, 1000);
}

function updateTimerUI() {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' + s : s}`;
    if (timeLeft < 60) document.getElementById('timer-display').style.color = 'red';
}

function gameOver(isWin) {
    clearInterval(timerInterval);
    document.getElementById('game-over-modal').style.display = 'flex';
    document.getElementById('final-pieces').innerText = piecesRevealed.size;

    if (isWin) {
        document.getElementById('end-title').innerText = "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼";
        document.getElementById('end-msg').innerHTML = "å¤ªå²å®³äº†ï¼<br>20åˆ†é˜å…§å®Œæˆäº†æ‹¼åœ–ï¼";
        speak("å¤ªå²å®³äº†ï¼æŒ‘æˆ°æˆåŠŸï¼");
    } else {
        document.getElementById('end-title').innerText = "æ™‚é–“åˆ°ï¼â°";
        document.getElementById('end-msg').innerText = "å·®ä¸€é»é»ï¼ä¸‹æ¬¡å†è©¦è©¦çœ‹ï¼";
        speak("æ™‚é–“åˆ°äº†ï¼Œä¸‹æ¬¡åŠ æ²¹ï¼");
    }
}

function speak(text) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-HK';
        window.speechSynthesis.speak(u);
    }
}

// --- æ‹¼åœ–é‚è¼¯ ---
function initPuzzle() {
    canvas = document.getElementById('puzzle-canvas');
    ctx = canvas.getContext('2d');
    img = new Image();
    img.crossOrigin = 'anonymous';

    img.onload = () => drawPuzzle(false);
    img.onerror = () => {
        console.log("åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨ fallback");
        drawPuzzle(true); // fallback æ¨¡å¼
    };
    img.src = puzzleUrl;
}

function drawPuzzle(isFallback) {
    ctx.clearRect(0, 0, 400, 320);

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            let idx = r * cols + c;
            let x = c * tileW;
            let y = r * tileH;

            if (piecesRevealed.has(idx)) {
                if (!isFallback && img.complete && img.naturalWidth > 0) {
                    try {
                        ctx.drawImage(img, c * (img.width / cols), r * (img.height / rows), img.width / cols, img.height / rows, x, y, tileW, tileH);
                    } catch (e) {
                        drawFallbackTile(x, y, true);
                    }
                } else {
                    drawFallbackTile(x, y, true);
                }
            } else {
                drawFallbackTile(x, y, false);
            }
        }
    }
    document.getElementById('progress-display').innerText = `${piecesRevealed.size}/${totalPieces}`;
}

function drawFallbackTile(x, y, isRevealed) {
    ctx.fillStyle = isRevealed ? '#b3e5fc' : '#e0e0e0';
    ctx.fillRect(x, y, tileW, tileH);
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, tileW, tileH);

    ctx.fillStyle = isRevealed ? '#0288d1' : '#bbb';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(isRevealed ? "âœ¨" : "?", x + tileW / 2, y + tileH / 2);
}

function revealPiece() {
    let avail = [];
    for (let i = 0; i < totalPieces; i++) if (!piecesRevealed.has(i)) avail.push(i);

    if (avail.length > 0) {
        let idx = avail[Math.floor(Math.random() * avail.length)];
        piecesRevealed.add(idx);
        drawPuzzle(img.onerror ? true : false); // ä¿æŒ fallback ç‹€æ…‹
        showRewardAnim();
        if (piecesRevealed.size === totalPieces) setTimeout(() => gameOver(true), 1000);
    }
}

function showRewardAnim() {
    const el = document.createElement('div');
    el.className = 'reward-pop';
    el.innerText = ['âœ¨','ğŸŒŸ','ğŸ§','ğŸ­','ğŸ’–'][Math.floor(Math.random()*5)];
    el.style.left = '50%'; el.style.top = '50%';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1000);
}

// --- æ™‚é˜ ---
function initClock() {
    const c = document.getElementById('clock-canvas');
    if (c) clockCtx = c.getContext('2d');
}

function drawClock(h, m) {
    if (!clockCtx) return;
    const ctx = clockCtx;
    ctx.clearRect(0, 0, 160, 160);
    ctx.save();
    ctx.translate(80, 80);

    ctx.beginPath(); ctx.arc(0, 0, 70, 0, 2 * Math.PI);
    ctx.fillStyle = 'white'; ctx.fill();
    ctx.lineWidth = 4; ctx.strokeStyle = '#546e7a'; ctx.stroke();

    ctx.fillStyle = '#333'; ctx.font = "bold 14px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
    for (let i = 1; i <= 12; i++) {
        let ang = i * Math.PI / 6;
        ctx.fillText(i, Math.sin(ang) * 58, -Math.cos(ang) * 58);
    }

    drawHand(ctx, (h % 12) * 30 + m * 0.5, 40, 5, '#333');
    drawHand(ctx, m * 6, 55, 3, '#e91e63');

    ctx.beginPath(); ctx.arc(0, 0, 5, 0, 2 * Math.PI); ctx.fillStyle = '#333'; ctx.fill();
    ctx.restore();
}

function drawHand(ctx, deg, len, w, color) {
    let rad = (deg - 90) * Math.PI / 180;
    ctx.beginPath(); ctx.lineWidth = w; ctx.lineCap = "round"; ctx.strokeStyle = color;
    ctx.moveTo(0, 0); ctx.lineTo(Math.cos(rad) * len, Math.sin(rad) * len); ctx.stroke();
}

// --- é¡Œç›®ç”Ÿæˆ ---
function generateQuestion() {
    // æ¸…ç©ºè¼¸å…¥
    document.getElementById('answer-math').value = '';
    document.getElementById('answer-h').value = '';
    document.getElementById('answer-m').value = '';
    document.getElementById('feedback').innerText = '';

    let qHtml = '';
    let hint = '';

    if (gameMode === 'mix') {
        // ... (ä¿æŒåŸæ¨£ï¼Œç„¡éœ€æ”¹)
        // Lv.1, Lv.2, Lv.3 é‚è¼¯åŒä¸Š
        // åªéœ€ç¢ºä¿ correctMath æ­£ç¢ºè¨­å®š
    } else if (gameMode === 'time') {
        if (level === 1) {
            let h = Math.floor(Math.random() * 12) + 1;
            let m = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
            drawClock(h, m);
            qHtml = `é˜é¢ä¸Šçš„æ™‚é–“æ˜¯ï¼Ÿ`;
            correctH = h;
            correctM = m;
        } else if (level === 2) {
            let startH = Math.floor(Math.random() * 8) + 1;
            let startM = [0, 30][Math.floor(Math.random() * 2)];
            let durH = Math.floor(Math.random() * 2) + 1;
            let durM = [0, 30][Math.floor(Math.random() * 2)];

            drawClock(startH, startM);

            let totalMin = startH * 60 + startM + durH * 60 + durM;
            let finalH = Math.floor(totalMin / 60);
            let finalM = totalMin % 60;

            let displayH = finalH % 12 || 12;  // ä¿®æ­£ bugï¼š12é»é¡¯ç¤º12è€Œé0

            qHtml = `ç¾åœ¨æ˜¯ ${startH}:${startM === 0 ? '00' : '30'}ï¼Œ<br>ç¶“é ${durH}å°æ™‚${durM === 0 ? '' : durM + 'åˆ†'}å¾Œæ˜¯å¹¾é»ï¼Ÿ`;
            correctH = displayH;
            correctM = finalM;
        } else if (level === 3) {
            let h24 = Math.floor(Math.random() * 24); // æ“´å¤§ç¯„åœ 0~23
            let m = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
            drawClock(h24 % 12 || 12, m);
            qHtml = `24å°æ™‚åˆ¶çš„ ${h24.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}<br>æ˜¯å¹¾é»ï¼ˆ12å°æ™‚åˆ¶ï¼‰ï¼Ÿ`;
            correctH = h24 % 12 || 12;
            correctM = m;
        }
    }

    document.getElementById('question-area').innerHTML = qHtml;
}

// --- æª¢æŸ¥ç­”æ¡ˆ ---
function checkAnswer() {
    let isCorrect = false;

    if (gameMode === 'mix') {
        const val = parseInt(document.getElementById('answer-math').value);
        if (!isNaN(val) && val === correctMath) isCorrect = true;
    } else if (gameMode === 'time') {
        const valH = parseInt(document.getElementById('answer-h').value);
        const valM = parseInt(document.getElementById('answer-m').value);
        if (!isNaN(valH) && !isNaN(valM) && valH === correctH && valM === correctM) {
            isCorrect = true;
        }
    }

    if (isCorrect) {
        speak("ç­”å°äº†ï¼å¥½å»å‘€ï¼");
        document.getElementById('feedback').innerText = "ç­”å°äº†ï¼âœ¨";
        document.getElementById('feedback').style.color = "#4caf50";
        revealPiece();
        // ç­”å°å¾Œæ¸…ç©ºè¼¸å…¥
        document.getElementById('answer-math').value = '';
        document.getElementById('answer-h').value = '';
        document.getElementById('answer-m').value = '';
        setTimeout(generateQuestion, 1500);
    } else {
        document.getElementById('feedback').innerText = "å†ç®—ä¸€æ¬¡çœ‹çœ‹ï¼ğŸ’ª";
        document.getElementById('feedback').style.color = "#e91e63";
        speak("å†è©¦ä¸€æ¬¡");
        // éŒ¯èª¤æ™‚æ¸…ç©ºä¸¦èšç„¦
        if (gameMode === 'time') {
            document.getElementById('answer-h').value = '';
            document.getElementById('answer-m').value = '';
            document.getElementById('answer-h').focus();
        } else {
            document.getElementById('answer-math').value = '';
            document.getElementById('answer-math').focus();
        }
    }
}
