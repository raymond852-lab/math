<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰æ¡‚ç‹— P3 æ•¸å­¸é™æ™‚æŒ‘æˆ°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root { --cinna-blue: #b3e5fc; --cinna-dark-blue: #0277bd; --cinna-pink: #ffc1e3; --cinna-dark-pink: #ec407a; --bg: #e1f5fe; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); margin: 0; padding: 0; text-align: center; user-select: none; -webkit-user-select: none; }
        
        /* é€šç”¨ä½ˆå±€ */
        .screen { display: none; padding: 15px; min-height: 100vh; box-sizing: border-box; flex-direction: column; align-items: center; }
        .screen.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; border-radius: 25px; border: 4px solid var(--cinna-blue); padding: 20px; width: 100%; max-width: 450px; box-shadow: 0 10px 0 rgba(179,229,252,0.5); margin-bottom: 20px; position: relative; transition: 0.2s; }
        
        /* æ¨™é¡Œèˆ‡æŒ‰éˆ• */
        h1 { color: var(--cinna-dark-blue); font-family: 'Fredoka One', cursive; letter-spacing: 1px; margin-bottom: 5px; }
        .btn { background: white; border: 2px solid var(--cinna-blue); padding: 15px; border-radius: 20px; font-size: 1.1rem; cursor: pointer; width: 100%; margin-bottom: 12px; font-weight: bold; color: #546e7a; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 0 #cfd8dc; transition: 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #cfd8dc; }
        .btn-start { background: var(--cinna-blue); color: var(--cinna-dark-blue); border: none; font-size: 1.3rem; }
        .btn-primary { background: var(--cinna-pink); color: white; border: none; box-shadow: 0 5px 0 var(--cinna-dark-pink); font-size: 1.3rem; border-radius: 50px; padding: 12px 40px; }
        .btn-primary:active { transform: translateY(5px); box-shadow: 0 0 0 var(--cinna-dark-pink); }
        .btn-back { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.9); border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; color: #777; cursor: pointer; z-index: 100; }

        /* HUD (è¨ˆæ™‚èˆ‡åˆ†æ•¸) */
        .hud-bar { display: flex; justify-content: space-between; width: 100%; max-width: 450px; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 50px; box-sizing: border-box; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .hud-item { font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .timer-danger { color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* éŠæˆ²å…ƒç´  */
        .math-input { width: 100px; font-size: 1.8rem; border: none; border-bottom: 4px solid var(--cinna-pink); text-align: center; outline: none; background: transparent; color: #333; }
        .keyword { color: var(--cinna-dark-pink); font-weight: bold; border-bottom: 2px dashed var(--cinna-dark-pink); }
        #clock-canvas { background: white; border-radius: 50%; border: 6px solid #546e7a; margin: 10px auto; display: block; max-width: 100%; }
        
        /* çµç®—ç•«é¢ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-content { background: white; padding: 30px; border-radius: 30px; text-align: center; border: 5px solid var(--cinna-pink); animation: popUp 0.5s; max-width: 350px; width: 90%; }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .reward-overlay { position: fixed; pointer-events:none; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 6rem; opacity: 0; z-index: 500; }
        .pop-anim { animation: rewardPop 0.8s forwards; }
        @keyframes rewardPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; } 100% { transform: translate(-50%, -100px) scale(1); opacity: 0; } }
    </style>
</head>
<body>

    <div id="reward-display" class="reward-overlay">âœ¨</div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--cinna-dark-blue)">æ™‚é–“åˆ°ï¼â°</h2>
            <p style="font-size: 1.2rem; color: #555;">æœ¬æ¬¡å¾—åˆ†</p>
            <div id="final-score" style="font-size: 4rem; color: var(--cinna-dark-pink); font-family:'Fredoka One';">0</div>
            <button class="btn-primary" onclick="goHome()">å›é¦–é </button>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div style="font-size: 5rem; margin-top: 40px; margin-bottom: 10px;">ğŸ¶</div>
        <h1>æ•¸å­¸é™æ™‚æŒ‘æˆ°</h1>
        <p style="color:#607d8b; margin-bottom: 30px;">æ¯å€‹æŒ‘æˆ°åªæœ‰ 2 åˆ†é˜ï¼åŠ æ²¹ï¼</p>
        
        <div class="card" style="border:none; background:none; box-shadow:none;">
            <button class="btn btn-start" onclick="startGame(1)">
                <span>âš¡ Level 1ï¼šé€Ÿç®—ç‰¹è¨“</span> <span>ğŸš€</span>
            </button>
            <button class="btn btn-start" style="background:#b2dfdb; color:#00695c; border-color:#80cbc4;" onclick="startGame(2)">
                <span>ğŸ§  Level 2ï¼šæ‡‰ç”¨é¡Œé‚è¼¯</span> <span>ğŸ“</span>
            </button>
            <button class="btn btn-start" style="background:#e1bee7; color:#6a1b9a; border-color:#ce93d8;" onclick="startGame(3)">
                <span>â° Level 3ï¼šæ™‚é–“å¤§å¸«</span> <span>âŒš</span>
            </button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button class="btn-back" onclick="goHome()">â¬… æ”¾æ£„</button>
        
        <div class="hud-bar">
            <div class="hud-item" style="color:#546e7a;">
                <span>â³</span> <span id="timer-display">02:00</span>
            </div>
            <div class="hud-item" style="color:var(--cinna-dark-pink);">
                <span>ğŸ†</span> <span id="score-display">0</span>
            </div>
        </div>

        <div class="card">
            
            <div id="game-l1" style="display:none;">
                <h3 style="color:#999; margin:0;">Level 1 é€Ÿç®—</h3>
                <div id="l1-q" style="font-size:3.5rem; color:#455a64; margin:30px 0; font-family: monospace;"></div>
                <input type="number" id="l1-ans" class="math-input" placeholder="?" inputmode="numeric">
                <br><br>
                <button class="btn-primary" onclick="checkL1()">æäº¤</button>
            </div>

            <div id="game-l2" style="display:none;">
                <h3 style="color:#999; margin:0;">Level 2 æ‡‰ç”¨é¡Œ</h3>
                <div id="l2-text" style="text-align:left; background:#f1f8e9; padding:15px; border-radius:15px; margin:15px 0; line-height:1.6; font-size:1.1rem;"></div>
                <button onclick="speakText(document.getElementById('l2-text').innerText)" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">ğŸ”Š</button>
                
                <div id="l2-step1">
                    <p style="font-weight:bold; color:#0277bd;">é€™é¡Œè¦ç”¨ä»€éº¼æ–¹æ³•ï¼Ÿ</p>
                    <div id="l2-ops" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
                </div>
                <div id="l2-step2" style="display:none;">
                    <p style="font-weight:bold; color:#ec407a;">ç­”æ¡ˆæ˜¯å¤šå°‘ï¼Ÿ</p>
                    <input type="number" id="l2-ans" class="math-input" inputmode="numeric">
                    <br><br>
                    <button class="btn-primary" onclick="checkL2Final()">æª¢æŸ¥</button>
                </div>
            </div>

            <div id="game-l3" style="display:none;">
                <h3 style="color:#999; margin:0;">Level 3 æ™‚é–“</h3>
                <canvas id="clock-canvas" width="200" height="200" style="display:none;"></canvas>
                <div id="l3-digital-wrap" style="display:none; background:#333; color:#0f0; padding:10px 20px; border-radius:10px; font-size:2rem; margin:10px auto; display:inline-block; font-family:monospace;">00:00</div>
                
                <div id="l3-text" style="text-align:left; margin:15px 0;"></div>
                <button onclick="speakText(document.getElementById('l3-text').innerText)" style="background:none; border:none; font-size:1.5rem;">ğŸ”Š</button>

                <div style="margin-top:15px;">
                    <input type="number" id="l3-h" class="math-input" style="width:60px;" placeholder="æ™‚"> : 
                    <input type="number" id="l3-m" class="math-input" style="width:60px;" placeholder="åˆ†">
                </div>
                <br>
                <button class="btn-primary" onclick="checkL3()">æäº¤</button>
            </div>

        </div>
        <div id="feedback-msg" style="height:30px; color:red; font-weight:bold;"></div>
    </div>

    <script>
        // --- å…¨å±€è®Šæ•¸ ---
        let score = 0;
        let timeLeft = 120; // 2åˆ†é˜
        let timerInterval;
        let currentLevel = 1;
        
        // Level Specific Data
        let l1Ans = 0;
        let l2Data = {};
        let l3Ans = {h:0, m:0};

        // --- æ ¸å¿ƒç³»çµ±åŠŸèƒ½ ---

        function goHome() {
            clearInterval(timerInterval);
            stopVoice();
            document.getElementById('game-over-modal').style.display = 'none';
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-home').classList.add('active');
        }

        function startGame(level) {
            currentLevel = level;
            score = 0;
            timeLeft = 120; // 2åˆ†é˜
            updateScoreDisplay();
            updateTimerDisplay();
            
            // åˆ‡æ›ç•«é¢
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-game').classList.add('active');
            
            // é¡¯ç¤ºå°æ‡‰é—œå¡ UI
            document.getElementById('game-l1').style.display = 'none';
            document.getElementById('game-l2').style.display = 'none';
            document.getElementById('game-l3').style.display = 'none';
            document.getElementById('game-l'+level).style.display = 'block';

            // å•Ÿå‹•è¨ˆæ™‚å™¨
            startTimer();

            // ç”Ÿæˆç¬¬ä¸€é¡Œ
            if(level === 1) generateL1();
            if(level === 2) generateL2();
            if(level === 3) generateL3();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if(timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            let text = `0${m}:${s < 10 ? '0'+s : s}`;
            const el = document.getElementById('timer-display');
            el.innerText = text;
            
            if(timeLeft <= 10) el.classList.add('timer-danger');
            else el.classList.remove('timer-danger');
        }

        function updateScoreDisplay() {
            document.getElementById('score-display').innerText = score;
        }

        function addScore(points) {
            score += points;
            updateScoreDisplay();
            // æ’­æ”¾å‹•ç•«
            const r = document.getElementById('reward-display');
            r.innerText = points > 50 ? "ğŸŒŸ +100" : "âœ¨";
            r.classList.remove('pop-anim');
            void r.offsetWidth; // trigger reflow
            r.classList.add('pop-anim');
            speakText("ç­”å°äº†");
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-over-modal').style.display = 'flex';
            speakText(`æ™‚é–“åˆ°ï¼Œä½ å¾—åˆ°äº† ${score} åˆ†ï¼`);
        }

        function feedback(msg) {
            const el = document.getElementById('feedback-msg');
            el.innerText = msg;
            speakText(msg);
            setTimeout(() => el.innerText = '', 1500);
        }

        function speakText(txt) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'zh-HK';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        function stopVoice() { window.speechSynthesis.cancel(); }

        // --- Level 1 é‚è¼¯ (é€Ÿç®—) ---
        function generateL1() {
            document.getElementById('l1-ans').value = '';
            const n1 = Math.floor(Math.random() * 12) + 2;
            const n2 = Math.floor(Math.random() * 9) + 2;
            if(Math.random() > 0.5) {
                l1Ans = n1 * n2;
                document.getElementById('l1-q').innerText = `${n1} Ã— ${n2}`;
            } else {
                l1Ans = n1 + n2;
                document.getElementById('l1-q').innerText = `${n1} + ${n2}`;
            }
            document.getElementById('l1-ans').focus();
        }

        function checkL1() {
            const val = parseInt(document.getElementById('l1-ans').value);
            if(val === l1Ans) {
                addScore(100);
                generateL1();
            } else {
                feedback("å†ç®—ç®—çœ‹ï¼");
            }
        }

        // --- Level 2 é‚è¼¯ (æ‡‰ç”¨é¡Œ) ---
        const l2Templates = [
            { t: 'x', get: (n1,n2,i) => ({ txt: `æ¯åŒ…æœ‰ ${n1} å€‹${i}ï¼Œè²·äº† ${n2} åŒ…ï¼Œ<span class='keyword'>å…±æœ‰</span>å¤šå°‘å€‹ï¼Ÿ`, ans: n1*n2, hint: "æ±‚ç¸½æ•¸ç”¨ä¹˜æ³•" }) },
            { t: 'Ã·', get: (n1,n2,i) => ({ txt: `æœ‰ ${n1*n2} å€‹${i}ï¼Œ<span class='keyword'>å¹³å‡åˆ†çµ¦</span> ${n2} äººï¼Œæ¯äººæœ‰å¹¾å€‹ï¼Ÿ`, ans: n1, hint: "å¹³å‡åˆ†ç”¨é™¤æ³•" }) },
            { t: '-', get: (n1,n2,i) => ({ txt: `æœ‰ ${n1+n2} å…ƒï¼Œè²·${i}ç”¨äº† ${n1} å…ƒï¼Œ<span class='keyword'>æ‰¾å›</span>å¤šå°‘å…ƒï¼Ÿ`, ans: n2, hint: "æ‰¾è´–ç”¨æ¸›æ³•" }) }
        ];

        function generateL2() {
            document.getElementById('l2-step1').style.display = 'block';
            document.getElementById('l2-step2').style.display = 'none';
            document.getElementById('l2-ans').value = '';
            
            const temp = l2Templates[Math.floor(Math.random()*l2Templates.length)];
            const item = ['ç³–æœ','è²¼ç´™','è˜‹æœ','æ°£çƒ'][Math.floor(Math.random()*4)];
            const n1 = Math.floor(Math.random()*8)+2;
            const n2 = Math.floor(Math.random()*5)+2;
            
            l2Data = { ...temp.get(n1,n2,item), type: temp.t };
            document.getElementById('l2-text').innerHTML = l2Data.txt;
            
            const opsDiv = document.getElementById('l2-ops');
            opsDiv.innerHTML = '';
            ['+','-','x','Ã·'].forEach(op => {
                let btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerText = op;
                btn.style.fontSize = '1.5rem';
                btn.onclick = () => {
                    if(op === l2Data.type) {
                        document.getElementById('l2-step1').style.display = 'none';
                        document.getElementById('l2-step2').style.display = 'block';
                        document.getElementById('l2-ans').focus();
                        feedback("è§€å¿µæ­£ç¢ºï¼");
                    } else feedback("ä¸å°å–”ï¼Œ" + l2Data.hint);
                }
                opsDiv.appendChild(btn);
            });
            speakText(document.getElementById('l2-text').innerText);
        }

        function checkL2Final() {
            if(parseInt(document.getElementById('l2-ans').value) === l2Data.ans) {
                addScore(100);
                generateL2();
            } else feedback("ç®—éŒ¯äº†ï¼");
        }

        // --- Level 3 é‚è¼¯ (æ™‚é–“) ---
        const ctx = document.getElementById('clock-canvas').getContext('2d');
        
        function drawClock(h, m) {
            ctx.clearRect(0,0,200,200); ctx.translate(100,100);
            ctx.beginPath(); ctx.arc(0,0,90,0,2*Math.PI); ctx.fillStyle='white'; ctx.fill(); ctx.stroke();
            for(let i=1; i<=12; i++) {
                ctx.rotate(i*Math.PI/6); ctx.translate(0,-75); ctx.rotate(-i*Math.PI/6);
                ctx.fillStyle='#546e7a'; ctx.font="bold 16px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(i,0,0);
                ctx.rotate(i*Math.PI/6); ctx.translate(0,75); ctx.rotate(-i*Math.PI/6);
            }
            drawHand((h%12)*Math.PI/6 + m*Math.PI/360, 50, 5, '#333'); 
            drawHand(m*Math.PI/30, 70, 3, '#e91e63');
            ctx.beginPath(); ctx.arc(0,0,5,0,2*Math.PI); ctx.fill();
            ctx.translate(-100,-100);
        }
        function drawHand(pos, len, w, color) {
            ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=w; ctx.lineCap="round";
            ctx.moveTo(0,0); ctx.rotate(pos); ctx.lineTo(0,-len); ctx.stroke(); ctx.rotate(-pos);
        }

        function generateL3() {
            document.getElementById('l3-h').value = ''; 
            document.getElementById('l3-m').value = '';
            
            const mode = Math.random() > 0.5 ? 'analog' : 'duration';
            const h = Math.floor(Math.random()*12)+1;
            const m = Math.floor(Math.random()*12)*5;
            
            if(mode === 'analog') {
                document.getElementById('clock-canvas').style.display = 'block';
                document.getElementById('l3-digital-wrap').style.display = 'none';
                drawClock(h, m);
                document.getElementById('l3-text').innerText = "è«‹å¯«å‡ºé˜é¢ä¸Šçš„æ™‚é–“ï¼š";
                l3Ans = {h, m};
            } else {
                document.getElementById('clock-canvas').style.display = 'none';
                document.getElementById('l3-digital-wrap').style.display = 'inline-block';
                const dur = 30 + Math.floor(Math.random()*6)*10; 
                document.getElementById('l3-digital-wrap').innerText = `${h}:${m<10?'0'+m:m}`;
                document.getElementById('l3-text').innerText = `ç¾åœ¨å¦‚åœ–ï¼Œç¶“é ${dur} åˆ†é˜å¾Œæ˜¯å¹¾é»ï¼Ÿ`;
                
                let total = m + dur;
                l3Ans.h = h + Math.floor(total/60);
                if(l3Ans.h > 12) l3Ans.h -= 12;
                l3Ans.m = total % 60;
            }
            speakText(document.getElementById('l3-text').innerText);
        }

        function checkL3() {
            const uh = parseInt(document.getElementById('l3-h').value);
            const um = parseInt(document.getElementById('l3-m').value);
            if(uh === l3Ans.h && um === l3Ans.m) {
                addScore(100);
                generateL3();
            } else feedback("æ™‚é–“ä¸å°å–”ï¼Œæ³¨æ„é€²ä½");
        }
    </script>
</body>
</html>
